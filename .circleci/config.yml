version: 2.1

jobs:
  build-push-img:
    machine:
      image: ubuntu-1604:202007-01
    # docker:
    #   - image: jdrouet/docker-with-buildx:stable-0.4.2
    steps:
      - checkout
      # - setup_remote_docker:
      #     version: 19.03.13
      - run: docker version
      - run:
          name: Build Docker image
          command: |
            docker context list
            echo '==========='
            docker context inspect default
            echo '==========='
            echo $DOCKER_HOST
            echo '==========='
            docker buildx ls

            docker buildx create --name mybuilder --use

            # # docker context create
            # docker context create \
            #   --docker host=$DOCKER_HOST \
            #   my-ctx
            # docker context use my-ctx

            # unset $DOCKER_HOST

            # # create a builder of docker-container driver type to make use of registry build cache exporter.
            # docker buildx create my-ctx --use

            # build
            docker buildx ls
workflows:
  myworkflow: # this is the name of our workflow
    jobs: # and here we list the jobs we are going to run.
      - build-push-img