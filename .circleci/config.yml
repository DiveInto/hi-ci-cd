version: 2.1

jobs:
  build-push-img:
    machine:
      image: ubuntu-2004:202008-01
    # docker:
    #   - image: jdrouet/docker-with-buildx:stable-0.4.2
    steps:
      - checkout
      # - setup_remote_docker:
      #     version: 19.03.13
      - run: docker version
      - run:
          name: Build Docker image
          command: |
            export DOCKER_CLI_EXPERIMENTAL=enabled

            docker buildx create --name mybuilder --use

            # login
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

            # build
            docker buildx build \
              --output=type=docker \
              --cache-from=type=registry,ref=diveinto/hi-ci-cd:cache \
              --cache-to=type=registry,ref=diveinto/hi-ci-cd:cache,mode=max \
              -t diveinto/hi-ci-cd:latest .

            echo '=========================='
            docker images

            echo '=========================='
            docker tag diveinto/hi-ci-cd:latest diveinto/hi-ci-cd:$CIRCLE_SHA1

            docker push diveinto/hi-ci-cd:latest
            docker push diveinto/hi-ci-cd:$CIRCLE_SHA1

            echo '=========================='
            docker images
  echo-in-cmd:
    docker:
      - image: circleci/ruby:2.4.1
    steps:
      - checkout
      - run:
          name: Build Docker image
          command: |
            read -d '' sql \<< EOF
            select c1, c2 from foo
            where c1='something'
            EOF

            echo $sql
workflows:
  myworkflow: # this is the name of our workflow
    jobs: # and here we list the jobs we are going to run.
      - build-push-img
  2ndworkflow:
    jobs:
      - echo-in-cmd
